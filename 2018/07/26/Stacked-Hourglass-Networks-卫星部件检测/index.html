<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="STACKED HOURGLASS NETWORKSSTACKED HOURGLASS NETWORKS 是由密歇根大学的研究团队设计的一个专门用来进行人体姿态估计的网络结构。在卫星的部件检测项目中，我们对其进行了修改和调整，利用同样的网络结构完成了太阳帆板的检测定位（类似图像分割任务）、发动机和对接环的定位（关键点检测任务）、发动机和对接环的检测定位（类似图像分割任务）。下面对 STACKED">
<meta name="keywords" content="DL">
<meta property="og:type" content="article">
<meta property="og:title" content="Stacked Hourglass Networks 卫星部件检测">
<meta property="og:url" content="http://yoursite.com/2018/07/26/Stacked-Hourglass-Networks-卫星部件检测/index.html">
<meta property="og:site_name" content="The next stop - Antarctica">
<meta property="og:description" content="STACKED HOURGLASS NETWORKSSTACKED HOURGLASS NETWORKS 是由密歇根大学的研究团队设计的一个专门用来进行人体姿态估计的网络结构。在卫星的部件检测项目中，我们对其进行了修改和调整，利用同样的网络结构完成了太阳帆板的检测定位（类似图像分割任务）、发动机和对接环的定位（关键点检测任务）、发动机和对接环的检测定位（类似图像分割任务）。下面对 STACKED">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/stacked-hg.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/hourglass.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/residual.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/intermediate_supervision.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_key_pts.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_key_pts_ret.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_ret.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_sol_pan.png">
<meta property="og:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_sol_pan_ret.png">
<meta property="og:updated_time" content="2018-08-26T10:49:56.044Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stacked Hourglass Networks 卫星部件检测">
<meta name="twitter:description" content="STACKED HOURGLASS NETWORKSSTACKED HOURGLASS NETWORKS 是由密歇根大学的研究团队设计的一个专门用来进行人体姿态估计的网络结构。在卫星的部件检测项目中，我们对其进行了修改和调整，利用同样的网络结构完成了太阳帆板的检测定位（类似图像分割任务）、发动机和对接环的定位（关键点检测任务）、发动机和对接环的检测定位（类似图像分割任务）。下面对 STACKED">
<meta name="twitter:image" content="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/stacked-hg.png">

<link rel="canonical" href="http://yoursite.com/2018/07/26/Stacked-Hourglass-Networks-卫星部件检测/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Stacked Hourglass Networks 卫星部件检测 | The next stop - Antarctica</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">The next stop - Antarctica</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">To see behind walls. To draw closer.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/Stacked-Hourglass-Networks-卫星部件检测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Fengcun Li">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="The next stop - Antarctica">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Stacked Hourglass Networks 卫星部件检测
        </h1>

        <div class="post-meta">
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2018-08-26 18:49:56" itemprop="dateModified" datetime="2018-08-26T18:49:56+08:00">2018-08-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="STACKED-HOURGLASS-NETWORKS"><a href="#STACKED-HOURGLASS-NETWORKS" class="headerlink" title="STACKED HOURGLASS NETWORKS"></a>STACKED HOURGLASS NETWORKS</h3><p><a href="http://www-personal.umich.edu/~alnewell/pose/" target="_blank" rel="noopener">STACKED HOURGLASS NETWORKS</a> 是由密歇根大学的研究团队设计的一个专门用来进行人体姿态估计的网络结构。在卫星的部件检测项目中，我们对其进行了修改和调整，利用同样的网络结构完成了太阳帆板的检测定位（类似图像分割任务）、发动机和对接环的定位（关键点检测任务）、发动机和对接环的检测定位（类似图像分割任务）。<br>下面对 STACKED HOURGLASS NETWORKS 进行介绍及对自主实现的 Keras 关键代码进行分析。<br><a id="more"></a></p>
<h3 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h3><p>在该论文中，作者指出：</p>
<blockquote>
<p>This work introduces a novel convolutional network architecture for the task of human pose estimation. Features are processed across all scales and consolidated to best capture the various spatial relationships associated with the body. We show how repeated bottom-up, top-down processing used in conjunction with intermediate supervision is critical to improving the performance of the network. We refer to the architecture as a “stacked hourglass” network based on the successive steps of pooling and upsampling that are done to produce a final set of predictions. State-of-the-art results are achieved on the FLIC and MPII benchmarks outcompeting all recent methods.</p>
</blockquote>
<p>特征在各个不同尺度上的进行处理并合并，可以让神经网络更好地把握部件的空间关系。将 bottom-up, top-down 的处理模块（hourglass 模块）进行重复堆叠（stack），在辅以中间监督 （intermediate supervision），可以极大地提高网络的性能。<br>实际上，是通过卷积神经网络对部件模型进行了编码表示，是一种隐式空间模型（implicit spatial model）。<br>STACKED HOURGLASS NETWORKS 与 CPM (Convolutional Pose Machines) 方法相比，思路更明晰，网络更简洁。<br><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/stacked-hg.png" alt="stacked hourglass"></p>
<h5 id="hourglass-模块"><a href="#hourglass-模块" class="headerlink" title="hourglass 模块"></a>hourglass 模块</h5><p>一个 hourglass 模块如下图所示，体现了跳级的思想。除红框内的 box 之外，每一个 box 都是一个 residual 模块的输出。<br>下图是 4 阶 hourglass 模块，进行了 4 次下采样（及对应的 4 次上采样）。n 阶 hourglass 模块可以提取从原始尺度到\(\frac{1}{2^n}\)<br>尺度的特征。<strong>在一个 hourglass 模块中特征图的通道数目保持不变。</strong><br><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/hourglass.png" alt="hourglass"></p>
<h5 id="residual-模块"><a href="#residual-模块" class="headerlink" title="residual 模块"></a>residual 模块</h5><p>一个 residual 模块如下图所示，residual 模块的 upper branch 是一个卷积模块 conv block，卷积模块首先进行一次\( 1 \times 1 \) 的卷积操作，缩减特征图的通道数目，然后进行一次 \( 3 \times 3 \)的卷积操作，最后再进行一次\( 1 \times 1 \)的卷积操作。residual 模块的 lower branch 是一个 skip layer，是一个跳级结构，在 skip layer 的输入与 conv block 的输出的通道数目不一致时，skip layer 会进行必要的 \( 1 \times 1 \) 卷积操作，使得其输出与 conv block 的输出通道数目一致，从而能够进行 element-wise 的相加。<br>一个 residual 模块可以看成是一个尺寸保持、通道数目可变可不变的“卷积层”。<br><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/residual.png" alt="residual"></p>
<h5 id="intermediate-supervision"><a href="#intermediate-supervision" class="headerlink" title="intermediate supervision"></a>intermediate supervision</h5><p>中间监督（intermediate supervision）的结构如下图所示，网络进行分支，并产生图中蓝色所示的热图（heatmap），热图可以被用来计算损失。在热图上应用一次 \( 1 \times 1\) 卷积操作，增加通道数目使得其可以与网络的中间特征图进行相加。图中虚线是来自上一个 hourglass 模块输出的特征图，这里也体现了跳级（skip layer）的思想。</p>
<p>跳级结构一方面可以看成是一个梯度反向传播的高速通道，另一方面也是网络正则化的一个替代，允许训练过程中神经网络自主选择其深度（结构复杂度）。<br><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/intermediate_supervision.png" alt="intermediate_supervision"></p>
<h5 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h5><p>对于 \( H \times W  \times N \)<br>的输入，每一个 hourglass 模块都会生成一个 \( \frac{H}{2}  \times \frac{W}{2} \times K\)<br>的热图。对于每个热图，都比较其与真值（groundtruth）的误差作为损失，体现了中间监督(intermediate supervision)的思想。</p>
<h5 id="预测"><a href="#预测" class="headerlink" title="预测"></a>预测</h5><p>在做预测时，仅选择最后一个 hourglass 模块输出的热图作为结果。</p>
<h3 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h3><h5 id="residual-模块-1"><a href="#residual-模块-1" class="headerlink" title="residual 模块"></a>residual 模块</h5><h6 id="conv-block"><a href="#conv-block" class="headerlink" title="conv block"></a>conv block</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv_block</span><span class="params">(inputs, num_output)</span>:</span></span><br><span class="line">    <span class="string">""" Convolutional Block</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        inputs  : Input Tensor (Not after being activated!!!!!)</span></span><br><span class="line"><span class="string">        num_output  : Desired output number of channel</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        output  : Output Tensor</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    x = BatchNormalization()(inputs)</span><br><span class="line">    x = Activation(<span class="string">'relu'</span>)(x)</span><br><span class="line">    x = Conv2D(num_output // <span class="number">2</span>, (<span class="number">1</span>, <span class="number">1</span>), strides=<span class="number">1</span>, padding=<span class="string">'valid'</span>)(x)</span><br><span class="line"></span><br><span class="line">    x = BatchNormalization()(x)</span><br><span class="line">    x = Activation(<span class="string">'relu'</span>)(x)</span><br><span class="line">    x = Conv2D(num_output // <span class="number">2</span>, (<span class="number">3</span>, <span class="number">3</span>), strides=<span class="number">1</span>, padding=<span class="string">'same'</span>)(x)</span><br><span class="line"></span><br><span class="line">    x = BatchNormalization()(x)</span><br><span class="line">    x = Activation(<span class="string">'relu'</span>)(x)</span><br><span class="line">    output = Conv2D(num_output, (<span class="number">1</span>, <span class="number">1</span>), strides=<span class="number">1</span>, padding=<span class="string">'valid'</span>)(x)</span><br><span class="line">    <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<h6 id="skip-layer"><a href="#skip-layer" class="headerlink" title="skip layer"></a>skip layer</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">skip_layer</span><span class="params">(inputs, num_output)</span>:</span></span><br><span class="line">    <span class="string">""" Skip Layer</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        inputs  : Input Tensor</span></span><br><span class="line"><span class="string">        num_output  : Desired output number of channel</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        Tensor of shape (None, inputs.height, inputs.width, num_output)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> inputs.get_shape().as_list()[<span class="number">3</span>] == num_output:</span><br><span class="line">        <span class="keyword">return</span> inputs</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        x = BatchNormalization()(inputs)</span><br><span class="line">        x = Activation(<span class="string">'relu'</span>)(x)</span><br><span class="line">        output = Conv2D(num_output, (<span class="number">1</span>, <span class="number">1</span>), strides=<span class="number">1</span>, padding=<span class="string">'valid'</span>)(x)</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<h6 id="residual"><a href="#residual" class="headerlink" title="residual"></a>residual</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">residual</span><span class="params">(inputs, num_output)</span>:</span></span><br><span class="line">    <span class="string">""" Residual Unit</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        inputs  : Input Tensor</span></span><br><span class="line"><span class="string">        num_output  : Number of Output Features (channels)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    convb = conv_block(inputs, num_output)</span><br><span class="line">    skipl = skip_layer(inputs, num_output)</span><br><span class="line">    <span class="keyword">return</span> Add()([convb, skipl])</span><br></pre></td></tr></table></figure>
<h5 id="hourglass-模块-1"><a href="#hourglass-模块-1" class="headerlink" title="hourglass 模块"></a>hourglass 模块</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hourglass</span><span class="params">(inputs, num_low, num_output)</span>:</span></span><br><span class="line">    <span class="string">""" Hourglass Module</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        inputs  : Input Tensor</span></span><br><span class="line"><span class="string">        num_low       : Number of downsampling step</span></span><br><span class="line"><span class="string">        num_output  : Number of Output Features (channels)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Upper Branch</span></span><br><span class="line">    up_1 = residual(inputs, num_output)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Lower Branch</span></span><br><span class="line">    low_ = MaxPooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>), strides=(<span class="number">2</span>, <span class="number">2</span>))(inputs)</span><br><span class="line">    low_1= residual(low_, num_output)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> num_low &gt; <span class="number">0</span>:</span><br><span class="line">        low_2 = hourglass(low_1, num_low<span class="number">-1</span>, num_output)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        low_2 = residual(low_1, num_output)</span><br><span class="line"></span><br><span class="line">    low_3 = residual(low_2, num_output)</span><br><span class="line"></span><br><span class="line">    up_2 = UpSampling2D(size=(<span class="number">2</span>, <span class="number">2</span>))(low_3)</span><br><span class="line">    <span class="keyword">return</span> Add()([up_2, up_1])</span><br></pre></td></tr></table></figure>
<h5 id="loss"><a href="#loss" class="headerlink" title="loss"></a>loss</h5><p>在使用 Keras 对损失函数进行实现的时候，需要注意的几点是：</p>
<ul>
<li>定义的 Python 损失函数需要传入模型的 <code>fit</code> 或者 <code>fit_generator</code> 方法，这两个方法会在内部调用该函数并为其传入训练数据中的标签和神经网络的输出，这两个参数是损失函数计算损失的唯二参数，此处由于使用中间监督的模型结构，即网络中间产生的热图也需要参与到损失值的计算，所以需要将所有这些热图都 stack 起来当作网络的输出，从而可以被传入损失函数完成损失值的计算。</li>
<li>Keras 中定义 loss，返回的是 batch_size 长度的 tensor， 而不是像 tensorflow 中那样是一个 scalar。</li>
<li><code>K.binary_crossentropy</code> 的默认设置是 <code>from_logits=False</code>,即该函数的默认设置假设输入是经过 <code>sigmoid</code> 激活之后的值，而不是仅经过卷积操作之后的<code>logits</code>，这是由其需要注意的一点，<code>K.binary_crossentropy</code> 的源码如下，如果<code>from_logits==True</code>，则直接调用 TensorFlow 的 <code>tf.nn.sigmoid_cross_entropy_with_logits</code>；如果<code>from_logits==False</code>，则首先将输入转换回 logits，再调用<code>tf.nn.sigmoid_cross_entropy_with_logits</code>。如果使用错误，就会 logits 就会被 <code>clip_by_value</code> 裁剪到（0，1）之间。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_crossentropy</span><span class="params">(target, output, from_logits=False)</span>:</span></span><br><span class="line">    <span class="string">"""Binary crossentropy between an output tensor and a target tensor.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Arguments</span></span><br><span class="line"><span class="string">        target: A tensor with the same shape as `output`.</span></span><br><span class="line"><span class="string">        output: A tensor.</span></span><br><span class="line"><span class="string">        from_logits: Whether `output` is expected to be a logits tensor.</span></span><br><span class="line"><span class="string">            By default, we consider that `output`</span></span><br><span class="line"><span class="string">            encodes a probability distribution.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # Returns</span></span><br><span class="line"><span class="string">        A tensor.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># Note: tf.nn.sigmoid_cross_entropy_with_logits</span></span><br><span class="line">    <span class="comment"># expects logits, Keras expects probabilities.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> from_logits:</span><br><span class="line">        <span class="comment"># transform back to logits</span></span><br><span class="line">        _epsilon = _to_tensor(epsilon(), output.dtype.base_dtype)</span><br><span class="line">        output = tf.clip_by_value(output, _epsilon, <span class="number">1</span> - _epsilon)</span><br><span class="line">        output = tf.log(output / (<span class="number">1</span> - output))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tf.nn.sigmoid_cross_entropy_with_logits(labels=target,</span><br><span class="line">                                                   logits=output)</span><br></pre></td></tr></table></figure>
<p>定义的损失函数如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loss</span><span class="params">(y_true, y_pred)</span>:</span></span><br><span class="line">	<span class="string">"""</span></span><br><span class="line"><span class="string">	# Arguments</span></span><br><span class="line"><span class="string">		y_true: A tensor of shape (batch_size, W, H, K), K is the num of heatmaps.</span></span><br><span class="line"><span class="string">		y_pred: A tensor of shape (batch_size, N, W, H, K), N is the num of hourglass modules. </span></span><br><span class="line"><span class="string">	"""</span></span><br><span class="line">    losses = []</span><br><span class="line">    shapes = y_pred.get_shape().as_list()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(shapes[<span class="number">1</span>]):</span><br><span class="line">        losses.append(K.reshape(</span><br><span class="line">            K.mean(K.binary_crossentropy(y_true, y_pred[:, i], from_logits=<span class="literal">True</span>), axis=<span class="number">-1</span>), </span><br><span class="line">            (<span class="number">-1</span>, shapes[<span class="number">2</span>]*shapes[<span class="number">3</span>])))</span><br><span class="line">    </span><br><span class="line">    loss = K.mean(K.mean(K.stack(losses, axis=<span class="number">1</span>), axis=<span class="number">1</span>), axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss</span><br></pre></td></tr></table></figure></p>
<h3 id="数据集及结果"><a href="#数据集及结果" class="headerlink" title="数据集及结果"></a>数据集及结果</h3><h5 id="发动机和对接环的定位（关键点检测任务）"><a href="#发动机和对接环的定位（关键点检测任务）" class="headerlink" title="发动机和对接环的定位（关键点检测任务）"></a>发动机和对接环的定位（关键点检测任务）</h5><h6 id="数据集"><a href="#数据集" class="headerlink" title="数据集"></a>数据集</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_key_pts.png" alt="satellite_key_pts"></p>
<h6 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_key_pts_ret.png" alt="satellite_key_pts_ret"></p>
<h5 id="发动机和对接环的检测定位（类似图像分割任务）"><a href="#发动机和对接环的检测定位（类似图像分割任务）" class="headerlink" title="发动机和对接环的检测定位（类似图像分割任务）"></a>发动机和对接环的检测定位（类似图像分割任务）</h5><h6 id="数据集-1"><a href="#数据集-1" class="headerlink" title="数据集"></a>数据集</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite.png" alt="satellite"></p>
<h6 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_ret.png" alt="satellite_ret"></p>
<h5 id="太阳帆板的检测定位（类似图像分割任务）"><a href="#太阳帆板的检测定位（类似图像分割任务）" class="headerlink" title="太阳帆板的检测定位（类似图像分割任务）"></a>太阳帆板的检测定位（类似图像分割任务）</h5><h6 id="数据集-2"><a href="#数据集-2" class="headerlink" title="数据集"></a>数据集</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_sol_pan.png" alt="satellite_sol_pan"></p>
<h6 id="结果-2"><a href="#结果-2" class="headerlink" title="结果"></a>结果</h6><p><img src="http://oytnj8g2y.bkt.clouddn.com/image/jpg/satellite/satellite_sol_pan_ret.png" alt="satellite_sol_pan_ret"></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DL/" rel="tag"># DL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/07/26/AP-and-mAP-in-object-detection/" rel="prev" title="AP and mAP (In Object Detection)">
      <i class="fa fa-chevron-left"></i> AP and mAP (In Object Detection)
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/08/01/Nvidia-Jetson-TX2-开箱及刷机/" rel="next" title="Nvidia Jetson TX2 开箱及刷机">
      Nvidia Jetson TX2 开箱及刷机 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#STACKED-HOURGLASS-NETWORKS"><span class="nav-number">1.</span> <span class="nav-text">STACKED HOURGLASS NETWORKS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网络结构"><span class="nav-number">2.</span> <span class="nav-text">网络结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#hourglass-模块"><span class="nav-number">2.0.1.</span> <span class="nav-text">hourglass 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#residual-模块"><span class="nav-number">2.0.2.</span> <span class="nav-text">residual 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#intermediate-supervision"><span class="nav-number">2.0.3.</span> <span class="nav-text">intermediate supervision</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#损失函数"><span class="nav-number">2.0.4.</span> <span class="nav-text">损失函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#预测"><span class="nav-number">2.0.5.</span> <span class="nav-text">预测</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关键代码"><span class="nav-number">3.</span> <span class="nav-text">关键代码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#residual-模块-1"><span class="nav-number">3.0.1.</span> <span class="nav-text">residual 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#conv-block"><span class="nav-number">3.0.1.1.</span> <span class="nav-text">conv block</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#skip-layer"><span class="nav-number">3.0.1.2.</span> <span class="nav-text">skip layer</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#residual"><span class="nav-number">3.0.1.3.</span> <span class="nav-text">residual</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hourglass-模块-1"><span class="nav-number">3.0.2.</span> <span class="nav-text">hourglass 模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#loss"><span class="nav-number">3.0.3.</span> <span class="nav-text">loss</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据集及结果"><span class="nav-number">4.</span> <span class="nav-text">数据集及结果</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#发动机和对接环的定位（关键点检测任务）"><span class="nav-number">4.0.1.</span> <span class="nav-text">发动机和对接环的定位（关键点检测任务）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#数据集"><span class="nav-number">4.0.1.1.</span> <span class="nav-text">数据集</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#结果"><span class="nav-number">4.0.1.2.</span> <span class="nav-text">结果</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发动机和对接环的检测定位（类似图像分割任务）"><span class="nav-number">4.0.2.</span> <span class="nav-text">发动机和对接环的检测定位（类似图像分割任务）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#数据集-1"><span class="nav-number">4.0.2.1.</span> <span class="nav-text">数据集</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#结果-1"><span class="nav-number">4.0.2.2.</span> <span class="nav-text">结果</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#太阳帆板的检测定位（类似图像分割任务）"><span class="nav-number">4.0.3.</span> <span class="nav-text">太阳帆板的检测定位（类似图像分割任务）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#数据集-2"><span class="nav-number">4.0.3.1.</span> <span class="nav-text">数据集</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#结果-2"><span class="nav-number">4.0.3.2.</span> <span class="nav-text">结果</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fengcun Li"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Fengcun Li</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fengcun Li</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  











<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
