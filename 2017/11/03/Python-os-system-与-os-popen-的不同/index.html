<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="两者是否等待子进程退出在参加阿里金服《商场中精确定位用户所在店铺》的算法比赛时，使用的是 pandas 和 sklearn ，虽然在数据预处理时使用了 pandas 的 melt 和 pivot 等“批处理”方式，避免了使用循环对每一条记录进行预处理，但是由于数据量较大还是挺费时的，且这个过程是单线程的。在使用 sklearn 的 RandomForestClassifier 时通过指定 n_jobs=-1，可以开启多线程进行训练。在数据预处理和模型拟合是串行的情况下，数据预处理阶段 CPU 的线程（服务器是8核16线程）是没有跑满的，这是一个性能瓶颈。因此想要通过多线程或者多进程的方式充分利用 CPU 的计算能力。达到下面的效果。由于不同商场记录数目不一，所需的预处理和模型拟合时间不一，期望达到同一时刻有的进程处在预处理阶段，有的进程处于模型拟合阶段，避免 CPU 计算能力的浪费。">
    

    <!--Author-->
    
        <meta name="author" content="Robert Lexis">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Python os.system 与 os.popen 的不同"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="This is Robert Lexis."/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Python os.system 与 os.popen 的不同 - This is Robert Lexis.</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2017/11/03/Python-os-system-与-os-popen-的不同/">
                Python os.system 与 os.popen 的不同
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-11-03</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h3 id="两者是否等待子进程退出"><a href="#两者是否等待子进程退出" class="headerlink" title="两者是否等待子进程退出"></a>两者是否等待子进程退出</h3><p>在参加阿里金服《商场中精确定位用户所在店铺》的算法比赛时，使用的是 pandas 和 sklearn ，虽然在数据预处理时使用了 pandas 的 <code>melt</code> 和 <code>pivot</code> 等“批处理”方式，避免了使用循环对每一条记录进行预处理，但是由于数据量较大还是挺费时的，且这个过程是单线程的。在使用 sklearn 的 <code>RandomForestClassifier</code> 时通过指定 <code>n_jobs=-1</code>，可以开启多线程进行训练。在数据预处理和模型拟合是串行的情况下，数据预处理阶段 CPU 的线程（服务器是8核16线程）是没有跑满的，这是一个性能瓶颈。因此想要通过多线程或者多进程的方式充分利用 CPU 的计算能力。达到下面的效果。<br><img src="http://oytnj8g2y.bkt.clouddn.com/multithread.png" alt="multiprocess"><br>由于不同商场记录数目不一，所需的预处理和模型拟合时间不一，期望达到同一时刻有的进程处在预处理阶段，有的进程处于模型拟合阶段，避免 CPU 计算能力的浪费。<br><a id="more"></a></p>
<p>因此尝试了 Python os.system 和 os.popen，发现两者在是否等待子进程退出上存在不同。</p>
<h4 id="os-system"><a href="#os-system" class="headerlink" title="os.system"></a>os.system</h4><p>main.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">print(&quot;Entering into main.py&quot;)</div><div class="line">os.system(&quot;python slave.py&quot;)</div><div class="line">print(&quot;Exiting from main.py&quot;)</div></pre></td></tr></table></figure></p>
<p>slave.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import time</div><div class="line">print(&quot;Entering into slave.py&quot;)</div><div class="line">time.sleep(10)</div><div class="line">print(&quot;Exiting from slave.py&quot;)</div></pre></td></tr></table></figure></p>
<p><code>python main.py</code>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Entering into main.py</div><div class="line">Entering into slave.py</div><div class="line">等待了大约10秒钟...</div><div class="line">Exiting from slave.py</div><div class="line">Exiting from main.py</div></pre></td></tr></table></figure></p>
<h4 id="os-popen"><a href="#os-popen" class="headerlink" title="os.popen"></a>os.popen</h4><p>main.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">print(&quot;Entering into main.py&quot;)</div><div class="line">ofp = os.popen(python slave.py&quot;)</div><div class="line">print(&quot;Exiting from main.py&quot;)</div></pre></td></tr></table></figure></p>
<p>slave.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import time</div><div class="line">print(&quot;Entering into slave.py&quot;)</div><div class="line">time.sleep(10)</div><div class="line">print(&quot;Exiting from slave.py&quot;)</div></pre></td></tr></table></figure></p>
<p><code>python main.py</code>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Entering into main.py</div><div class="line">Exiting from main.py</div><div class="line">等待了大约10秒钟...</div><div class="line">Exception ignored in: &lt;_io.TextIOWrapper name=&apos;&lt;stdout&gt;&apos; mode=&apos;w&apos; encoding=&apos;UTF-8&apos;&gt;</div><div class="line">BrokenPipeError: [Errno 32] Broken pipe</div></pre></td></tr></table></figure></p>
<p>上面报错是因为<code>os.popen(python slave.py&quot;)</code>：</p>
<blockquote>
<p>os.popen: Open a pipe to or from command. The return value is an open file object connected to the pipe, which can be read or written depending on whether mode is ‘r’ (default) or ‘w’. </p>
</blockquote>
<p>main.py 建立了 pipe ，但是 main.py 却又提前退出中断了pipe，当 <code>python slave.py</code>运行完之后想要向这个 pipe 的缓冲里面写入时，就会报出<code>BrokenPipeError</code>。<br>修改 main.py 让主进程等待子进程返回，从而允许<code>python slave.py</code>运行完之后向 pipe 的缓冲写入。<br>main.py<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">print(&quot;Entering into main.py&quot;)</div><div class="line">ofp = os.popen(python slave.py&quot;)</div><div class="line">print(ofp.readlines())</div><div class="line">print(&quot;Exiting from main.py&quot;)</div></pre></td></tr></table></figure></p>
<p><code>python main.py</code>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Entering into main.py</div><div class="line">等待了大约10秒钟...</div><div class="line">[&apos;Entering into slave.py\n&apos;, &apos;Exiting from slave.py\n&apos;]</div><div class="line">Exiting from main.py</div></pre></td></tr></table></figure></p>
<p>这次在退出主进程 main.py 之前等待了10秒钟，这是因为<code>print(ofp.readlines())</code>需要读取 pipe 缓冲里的内容，因此堵塞在这一行。</p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ol>
<li>os.system 会等待子进程的退出。</li>
<li>popen 不会等待子进程的退出，但是主进程如果提前退出会 break pipe 从而导致 BrokenPipeError。</li>
<li>另外  <code>os.system</code> 只会返回子进程 exit 的代号，popen 则会建立一个 pipe 来接收子进程的“print”，可以利用 popen 将一系列具有输入输出依赖关系的命令形成管道（命令1–&gt;命令2–&gt;命令3–&gt;）。</li>
<li>在不需要利用 pipe 形成命令管道的情况下，使用 os.system 新建一个子进程是比较合适的。 </li>
</ol>
<h4 id="最终的解决方案"><a href="#最终的解决方案" class="headerlink" title="最终的解决方案"></a>最终的解决方案</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import os</div><div class="line">import threading</div><div class="line">import time</div><div class="line">def func(begin, end):</div><div class="line">    print(&quot;Starting mall [&#123;&#125; to &#123;&#125;)&quot;.format(begin, end))</div><div class="line">    os.system(&quot;python train_horizon_cv.py &#123;&#125; &#123;&#125; &gt;&gt; log_&#123;&#125;_&#123;&#125;.txt&quot;.format(begin, end, begin, end))</div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    threadpool=[]</div><div class="line">    nos = [0, 40, 97]</div><div class="line">    for i in range(2):</div><div class="line">        th = threading.Thread(target=func,args=(nos[i], nos[i+1]))</div><div class="line">        threadpool.append(th)</div><div class="line">    for th in threadpool:</div><div class="line">        th.start()</div><div class="line">    for th in threadpool:</div><div class="line">        threading.Thread.join(th)</div></pre></td></tr></table></figure>
<p>通过两个线程去启动两个训练进程，每个线程等待其启动的训练进程，主线程等待两个子线程。<br>如果直接像下面这样把 os.system 写在一个循环里面，实际上两个训练进程仍然是串行执行的，这是由于 os.system 的等待子进程返回的性质决定的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nos = [0, 40, 97]</div><div class="line">for i in range(2):</div><div class="line">    os.system(&quot;python train_horizon_cv.py &#123;&#125; &#123;&#125; &gt;&gt; log_&#123;&#125;_&#123;&#125;.txt&quot;.format(nos[i], nos[i+1], nos[i], nos[i+1]))</div></pre></td></tr></table></figure></p>
<p><img src="http://oytnj8g2y.bkt.clouddn.com/multithread2.png" alt="multithread2"></p>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This is Robert Lexis (FengCun Li). To see the world, things dangerous to come to, to see behind walls, to draw closer, to find each other and to feel. That is the purpose of LIFE.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/05/08/Static-variable-in-inlined-function/">Static variable in inline</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/23/Iterator-invalidation-rules/">Iterator invalidation rul</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/18/Emplace-back/">Emplace back</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/14/Perfect-forward/">Perfect forward</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/RobertLexis">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:robert_lexis@163.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Robert Lexis Loves Wenny
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>