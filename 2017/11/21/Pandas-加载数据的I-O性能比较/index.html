<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Pandas 加载数据的I/O性能比较在使用阿里巴巴集群数据时，由于数据量比较大，对数据进行分析前加载数据需要花费较长的时间，因此测试了 Pandas 读取数据不同方法的 I/O 性能。测试数据:1234batch_instance.csv 819Mwc -l batch_instance.csv 16094656 batch_instance.csv">
    

    <!--Author-->
    
        <meta name="author" content="Robert Lexis">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Pandas 加载数据的I/O性能比较"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="This is Robert Lexis."/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Pandas 加载数据的I/O性能比较 - This is Robert Lexis.</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2017/11/21/Pandas-加载数据的I-O性能比较/">
                Pandas 加载数据的I/O性能比较
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-11-21</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h3 id="Pandas-加载数据的I-O性能比较"><a href="#Pandas-加载数据的I-O性能比较" class="headerlink" title="Pandas 加载数据的I/O性能比较"></a>Pandas 加载数据的I/O性能比较</h3><p>在使用阿里巴巴集群数据时，由于数据量比较大，对数据进行分析前加载数据需要花费较长的时间，因此测试了 Pandas 读取数据不同方法的 I/O 性能。<br>测试数据:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">batch_instance.csv 819M</div><div class="line"></div><div class="line">wc -l batch_instance.csv </div><div class="line">16094656 batch_instance.csv</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>首先测试了 read_csv 和 read_sql_query (mysql) 的读取性能：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">import pandas as pd </div><div class="line">from sqlalchemy import create_engine</div><div class="line">import time</div><div class="line"></div><div class="line">tic = time.time()</div><div class="line">df = pd.read_csv(&quot;/home/shark/Codes/Sigma/batch_instance.csv&quot;)</div><div class="line">toc = time.time()</div><div class="line">print(&quot;read_csv costed &#123;:.3f&#125;s&quot;.format(toc - tic))</div><div class="line"></div><div class="line">engine = create_engine(&quot;mysql://root:lexis@localhost:3306/Alibaba&quot;)</div><div class="line">query = &quot;select * from batch_instance&quot;</div><div class="line">tic = time.time()</div><div class="line">df = pd.read_sql_query(query, engine)</div><div class="line">toc = time.time()</div><div class="line">print(&quot;read_sql_query costed &#123;:.3f&#125;s&quot;.format(toc - tic))</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">read_csv costed 12.897s</div><div class="line">read_sql_query costed 134.118s</div></pre></td></tr></table></figure></p>
<p>相比 read_csv ，read_sql_query 的速度要慢的很，这是因为此处做的是表扫描的工作，并不能充分发挥数据库的索引查询的强大功能。CSV 和 SQL 本来就不是用来做相同的工作的。<br>想象有一个从 1920 到 2017的时间序列，而你只需要从 2010 到 2017 的数据，CSV 的方式是将数据全部加载然后选择 2010 到 2017 年的数据，而SQL 是事先筛选数据然后再返回，如果将时间这一列设置为 index，会获得<strong>极大</strong>的性能提升。</p>
<p>下面是根据 Pandas 文档进行的测试：<br>test_pd_io.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">from</span> pandas.io <span class="keyword">import</span> sql</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_sql_write</span><span class="params">(df)</span>:</span></div><div class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">'test.sql'</span>):</div><div class="line">        os.remove(<span class="string">'test.sql'</span>)</div><div class="line">    sql_db = sqlite3.connect(<span class="string">'test.sql'</span>)</div><div class="line">    df.to_sql(name=<span class="string">'test_table'</span>, con=sql_db)</div><div class="line">    sql_db.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_sql_read</span><span class="params">()</span>:</span></div><div class="line">    sql_db = sqlite3.connect(<span class="string">'test.sql'</span>)</div><div class="line">    pd.read_sql_query(<span class="string">"select * from test_table"</span>, sql_db)</div><div class="line">    sql_db.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_fixed_write</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_hdf(<span class="string">'test_fixed.hdf'</span>,<span class="string">'test'</span>,mode=<span class="string">'w'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_fixed_read</span><span class="params">()</span>:</span></div><div class="line">    pd.read_hdf(<span class="string">'test_fixed.hdf'</span>,<span class="string">'test'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_fixed_write_compress</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_hdf(<span class="string">'test_fixed_compress.hdf'</span>,<span class="string">'test'</span>,mode=<span class="string">'w'</span>,complib=<span class="string">'blosc'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_fixed_read_compress</span><span class="params">()</span>:</span></div><div class="line">    pd.read_hdf(<span class="string">'test_fixed_compress.hdf'</span>,<span class="string">'test'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_table_write</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_hdf(<span class="string">'test_table.hdf'</span>,<span class="string">'test'</span>,mode=<span class="string">'w'</span>,format=<span class="string">'table'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_table_read</span><span class="params">()</span>:</span></div><div class="line">    pd.read_hdf(<span class="string">'test_table.hdf'</span>,<span class="string">'test'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_table_write_compress</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_hdf(<span class="string">'test_table_compress.hdf'</span>,<span class="string">'test'</span>,mode=<span class="string">'w'</span>,complib=<span class="string">'blosc'</span>,format=<span class="string">'table'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_hdf_table_read_compress</span><span class="params">()</span>:</span></div><div class="line">    pd.read_hdf(<span class="string">'test_table_compress.hdf'</span>,<span class="string">'test'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_csv_write</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_csv(<span class="string">'test.csv'</span>,mode=<span class="string">'w'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_csv_read</span><span class="params">()</span>:</span></div><div class="line">    pd.read_csv(<span class="string">'test.csv'</span>,index_col=<span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_feather_write</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_feather(<span class="string">'test.feather'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_feather_read</span><span class="params">()</span>:</span></div><div class="line">    pd.read_feather(<span class="string">'test.feather'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pickle_write</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_pickle(<span class="string">'test.pkl'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pickle_read</span><span class="params">()</span>:</span></div><div class="line">    pd.read_pickle(<span class="string">'test.pkl'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pickle_write_compress</span><span class="params">(df)</span>:</span></div><div class="line">    df.to_pickle(<span class="string">'test.pkl.compress'</span>, compression=<span class="string">'xz'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pickle_read_compress</span><span class="params">()</span>:</span></div><div class="line">    pd.read_pickle(<span class="string">'test.pkl.compress'</span>, compression=<span class="string">'xz'</span>)</div></pre></td></tr></table></figure></p>
<p>测试写性能：<br>ipython<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">In [2]: import pandas as pd</div><div class="line"></div><div class="line">In [3]: df = pd.read_csv(&quot;/home/shark/Codes/Sigma/batch_instance.csv&quot;)</div><div class="line"></div><div class="line">In [4]: from test_pd_io import *</div><div class="line"></div><div class="line">In [5]: %timeit test_sql_write(df)</div><div class="line">1 loop, best of 3: 2min 20s per loop</div><div class="line"></div><div class="line">In [6]: %timeit test_hdf_fixed_write(df)</div><div class="line">1 loop, best of 3: 6.14 s per loop</div><div class="line"></div><div class="line">In [7]: %timeit test_hdf_fixed_write_compress(df)</div><div class="line">1 loop, best of 3: 5.6 s per loop</div><div class="line"></div><div class="line">In [8]: %timeit test_hdf_table_write(df)</div><div class="line">1 loop, best of 3: 25.9 s per loop</div><div class="line"></div><div class="line">In [9]:  %timeit test_hdf_table_write_compress(df)</div><div class="line">1 loop, best of 3: 21.8 s per loop</div><div class="line"></div><div class="line">In [10]: %timeit test_csv_write(df)</div><div class="line">1 loop, best of 3: 2min 44s per loop</div><div class="line"></div><div class="line">In [11]: %timeit test_feather_write(df)</div><div class="line">1 loop, best of 3: 3.99 s per loop</div><div class="line"></div><div class="line">In [12]: %timeit test_pickle_write(df)</div><div class="line">1 loop, best of 3: 4.43 s per loop</div><div class="line"></div><div class="line">In [13]: %timeit test_pickle_write_compress(df)</div><div class="line">1 loop, best of 3: 6min 27s per loop</div></pre></td></tr></table></figure></p>
<p>测试读性能：<br>ipython<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">In [7]: %timeit test_sql_read()</div><div class="line">1 loop, best of 3: 1min 17s per loop</div><div class="line"></div><div class="line">In [8]: %timeit test_hdf_fixed_read()</div><div class="line">1 loop, best of 3: 972 ms per loop</div><div class="line"></div><div class="line">In [9]: %timeit test_hdf_fixed_read_compress()</div><div class="line">1 loop, best of 3: 2.41 s per loop</div><div class="line"></div><div class="line">In [10]: %timeit test_hdf_table_read()</div><div class="line">1 loop, best of 3: 17.5 s per loop</div><div class="line"></div><div class="line">In [11]: %timeit test_hdf_table_read_compress()</div><div class="line">1 loop, best of 3: 18.1 s per loop</div><div class="line"></div><div class="line">In [12]: %timeit test_csv_read()</div><div class="line">1 loop, best of 3: 17.1 s per loop</div><div class="line"></div><div class="line">In [13]: %timeit test_feather_read()</div><div class="line">1 loop, best of 3: 1.99 s per loop</div><div class="line"></div><div class="line">In [14]: %timeit test_pickle_read()</div><div class="line">1 loop, best of 3: 1.14 s per loop</div><div class="line"></div><div class="line">In [15]: %timeit test_pickle_read_compress()</div><div class="line">1 loop, best of 3: 9.72 s per loop</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>数据格式</th>
<th>空间</th>
<th>写性能</th>
<th>读性能</th>
</tr>
</thead>
<tbody>
<tr>
<td>test.csv</td>
<td>1.0G</td>
<td>2min 44s</td>
<td>17.1 s</td>
</tr>
<tr>
<td>test.feather</td>
<td>1.6G</td>
<td><strong>3.99 s</strong></td>
<td>1.99 s</td>
</tr>
<tr>
<td>test_fixed_compress.hdf</td>
<td>423M</td>
<td>5.6 s</td>
<td>2.41 s</td>
</tr>
<tr>
<td>test_fixed.hdf</td>
<td>1.6G</td>
<td>6.14 s</td>
<td><strong>972 ms</strong></td>
</tr>
<tr>
<td>test.pkl</td>
<td>1.4G</td>
<td>4.43 s</td>
<td>1.14 s</td>
</tr>
<tr>
<td>test.pkl.compress</td>
<td>66M</td>
<td>6min 27s</td>
<td>9.72 s</td>
</tr>
<tr>
<td>test.sql</td>
<td>1.2G</td>
<td>2min 20s</td>
<td>1min 17s</td>
</tr>
<tr>
<td>test_table_compress.hdf</td>
<td>299M</td>
<td>21.8 s</td>
<td>18.1 s</td>
</tr>
<tr>
<td>test_table.hdf</td>
<td>1.7G</td>
<td>25.9 s</td>
<td>17.5 s</td>
</tr>
</tbody>
</table>

    </div>

    

    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This is Robert Lexis (FengCun Li). To see the world, things dangerous to come to, to see behind walls, to draw closer, to find each other and to feel. That is the purpose of LIFE.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/05/08/Static-variable-in-inlined-function/">Static variable in inline</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/04/23/Iterator-invalidation-rules/">Iterator invalidation rul</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/18/Emplace-back/">Emplace back</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/14/Perfect-forward/">Perfect forward</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/RobertLexis">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:robert_lexis@163.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Robert Lexis Loves Wenny
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>