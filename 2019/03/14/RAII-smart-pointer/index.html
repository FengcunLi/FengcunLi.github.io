<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="RAIIRAII 全称为 Resource Acquisition Is Initialization，1984-1989 年期间，比雅尼·斯特劳斯特鲁普和安德鲁·柯尼希在设计 C++ 异常时，为解决资源管理时的异常安全性而使用了 RAII。
RAII要求，资源的有效期与持有资源的对象的生命期严格绑">
    

    <!--Author-->
    
        <meta name="author" content="Robert Lexis">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="RAII &amp; smart pointer"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="This is Robert Lexis."/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>RAII &amp; smart pointer - This is Robert Lexis.</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2019/03/14/RAII-smart-pointer/">
                RAII & smart pointer
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2019-03-14</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h3 id="RAII"><a href="#RAII" class="headerlink" title="RAII"></a>RAII</h3><p>RAII 全称为 <em>Resource Acquisition Is Initialization</em>，1984-1989 年期间，比雅尼·斯特劳斯特鲁普和安德鲁·柯尼希在设计 C++ 异常时，为解决<strong>资源管理</strong>时的<strong>异常安全性</strong>而使用了 <strong>RAII</strong>。</p>
<p>RAII要求，资源的有效期与持有资源的对象的生命期严格绑定，即由对象的构造函数完成资源的获取，由析构函数完成资源的释放，在这种要求下，只要对象能正确地析构，就不会出现资源泄露问题。</p>
<p>C++ 保证了所有<strong>栈对象</strong>在生命周期结束时都会被销毁，无论是否发生了异常。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdexcept&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_to_file</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp; message)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// 创建关于文件的互斥锁</span></div><div class="line">    <span class="keyword">static</span> <span class="built_in">std</span>::mutex mutex;</div><div class="line">    <span class="comment">// 在访问文件前进行加锁</span></div><div class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mutex);</div><div class="line">    <span class="comment">// 尝试打开文件</span></div><div class="line">    <span class="built_in">std</span>::<span class="function">ofstream <span class="title">file</span><span class="params">(<span class="string">"example.txt"</span>)</span></span>;</div><div class="line">    <span class="keyword">if</span> (!file.is_open())</div><div class="line">        <span class="keyword">throw</span> <span class="built_in">std</span>::runtime_error(<span class="string">"unable to open file"</span>);</div><div class="line"></div><div class="line">    file &lt;&lt; message &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 当离开作用域时，文件句柄会被首先析构 (不管是否抛出了异常)</span></div><div class="line">    <span class="comment">// lock 也会被析构 (不管是否抛出了异常)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>无论在 <code>write_to_file</code> 函数正常返回，还是在途中抛出了异常，都会引发 <code>write_to_file</code> 函数的<em>栈回退</em>，而此时会<strong>依次</strong>自动调用 <code>file</code> 和 <code>lock</code> 对象的析构函数。此处借由 RAII 思想管理的资源是互斥锁 <code>mutex</code>，<code>lock</code> 的构造和析构保证了互斥锁的获取和释放。</p>
<p>由于 RAII 可以极大地简化资源管理，并有效地保证程序的正确和代码的简洁，所以通常会强烈建议在 C++ 中使用它。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Mutex</span>&gt; <span class="title">class</span> <span class="title">lock_guard</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    Mutex&amp; mutex_;</div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    lock_guard(Mutex&amp; mutex) : mutex_(mutex) &#123; mutex_.lock(); &#125;</div><div class="line">    ~lock_guard() &#123; mutex_.unlock(); &#125;</div><div class="line"></div><div class="line">    lock_guard(lock_guard <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</div><div class="line">    lock_guard&amp; <span class="keyword">operator</span>=(lock_guard <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>程序员可以非常方便地使用 <code>lock_guard</code>，而不用担心异常安全性问题<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">unsafe_code</span><span class="params">()</span></span>;  <span class="comment">// 可能抛出异常</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="built_in">std</span>::mutex;</div><div class="line"><span class="keyword">using</span> <span class="built_in">std</span>::lock_guard;</div><div class="line"></div><div class="line">mutex g_mutex;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">access_critical_section</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    lock_guard&lt;mutex&gt; lock(g_mutex);</div><div class="line">    unsafe_code();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>C++</code> 标准库的实现广泛应用了 RAII，典型的如容器、智能指针等。</p>
<h3 id="Smart-Pointer"><a href="#Smart-Pointer" class="headerlink" title="Smart Pointer"></a>Smart Pointer</h3><p>在内存资源管理中，程序员有义务对动态分配的内存进行释放，即谁申请谁释放，并且 <code>delete</code> 掉一个指针之后，最好马上将其赋值为 <code>NULL</code>（避免使用悬垂指针）。这个过程繁杂极易出错。由 RAII 的思想，可以将资源的有效期和管理对象的生命期进行严格绑定，通过对象的构造和析构完成资源的获取和释放。</p>
<h4 id="auto-ptr"><a href="#auto-ptr" class="headerlink" title="auto_ptr"></a>auto_ptr</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">auto_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_1(<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">"Hello, auto_ptr!"</span>));</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"The content is: "</span> &lt;&lt; *ptr_1 &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ptr_1</code> 仅仅就是一个对象，只不过这个对象用起来就像一个指针一样，<code>new string(&quot;Hello, auto_ptr!&quot;)</code> 资源的有效期和管理对象 <code>ptr_1</code> 的生命期进行严格绑定，在 <code>ptr_1</code> 析构时会完成资源的释放。</p>
<p>在 C++11 标准中，<code>auto_ptr</code> 已经被弃用了，这是因为：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">auto_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_1(<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">"Hello, auto_ptr!"</span>));</div><div class="line">    <span class="built_in">auto_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_2;</div><div class="line">    ptr_2 = ptr_1;</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_2: "</span> &lt;&lt; *ptr_2 &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// OK</span></div><div class="line">    <span class="comment">// cout &lt;&lt; "ptr_1: " &lt;&lt; *ptr_1 &lt;&lt; endl; // Error</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>为了避免重复析构问题，当发生<strong>拷贝构造/拷贝赋值</strong>时，源智能指针对象内的指针会被赋值为 <code>NULL</code>; 这就出现了语义冲突，此处的<strong>拷贝语义</strong>实际上发生的是 C++11 新引进的 move 语义对应的操作，这也无可厚非，毕竟在 <code>auto_ptr</code> 引入之时，C++ 中并没有右值引用来支持移动语义，就只能用拷贝语义来错误的将就。</p>
<h4 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h4><p><code>unique_ptr</code> 是 <code>auto_ptr</code> 的替代者，它实现了移动语义，禁止了拷贝语义。被管理的资源的所有权只有一份，可以在 <code>unique_ptr</code> 对象之间转移。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">unique_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_1(<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">"Hello, unique_ptr!"</span>));</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 is: "</span> &lt;&lt; *ptr_1 &lt;&lt; <span class="string">", ptr value is: "</span> &lt;&lt; ptr_1.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="comment">// unique_ptr&lt;string&gt; ptr_2(ptr_1);     // 编译将会出错！因为禁止拷贝构造</span></div><div class="line">    <span class="comment">// unique_ptr&lt;string&gt; ptr_2</span></div><div class="line">    <span class="comment">// ptr_2 = ptr_1;    // 编译将会出错！因为禁止拷贝赋值</span></div><div class="line">    <span class="built_in">unique_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_2 = <span class="built_in">std</span>::move(ptr_1); <span class="comment">// 调用移动构造函数</span></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 is: "</span> &lt;&lt; ptr_1.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_2 is: "</span> &lt;&lt; *ptr_2 &lt;&lt; <span class="string">", ptr value is: "</span> &lt;&lt; ptr_2.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ptr_1 is: Hello, unique_ptr!, ptr value is: 0x1d8dc20</div><div class="line">ptr_1 is: 0</div><div class="line">ptr_2 is: Hello, unique_ptr!, ptr value is: 0x1d8dc20</div></pre></td></tr></table></figure></p>
<p>使用 <code>unique_ptr</code>，可以实现以下功能：</p>
<ol>
<li>为动态申请的内存提供异常安全</li>
<li>将动态申请内存的所有权传递给某个函数</li>
<li>从某个函数返回动态申请内存的所有权</li>
</ol>
<h4 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h4><p>引用计数！每次有一个 <code>shared_ptr</code> 关联到某个对象上时，计数值就加上 <code>1</code>；相反，每次有一个 <code>shared_ptr</code> 析构时，相应的计数值就减去 <code>1</code>。当计数值减为 <code>0</code> 的时候，就执行对象的析构函数，此时该对象才真正被析构！多个 <code>shared_ptr</code> 指向同一个动态对象，并维护了一个共享的引用计数器，记录了引用同一对象的 <code>shared_ptr</code> 实例的数量。当最后一个指向动态对象的 <code>shared_ptr</code> 销毁时，会自动销毁其所指对象。<br>基本操作：</p>
<ol>
<li>绑定对象的变更(reset)</li>
<li>shared_ptr 的销毁(手动赋值为 nullptr 或离开作用域)</li>
<li>指定deleter</li>
</ol>
<p><code>shared_ptr</code> 的创建，有两种方式：</p>
<ol>
<li>使用函数 make_shared</li>
<li>使用构造函数(可从原生指针、unique_ptr、另一个 shared_ptr 创建)<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; p1 = make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">1</span>);</div><div class="line"><span class="built_in">shared_ptr</span>&lt;<span class="keyword">int</span>&gt; p2(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">2</span>));</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_1(<span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">"Hello, shared_ptr!"</span>));</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_2 = ptr_1;</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_3(ptr_1);</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Count is: "</span> &lt;&lt; ptr_1.use_count() &lt;&lt; <span class="string">", "</span></div><div class="line">    &lt;&lt; ptr_2.use_count() &lt;&lt; <span class="string">", "</span> &lt;&lt; ptr_3.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 is: "</span>  &lt;&lt; ptr_1.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_2 is: "</span> &lt;&lt; ptr_2.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_3 is: "</span> &lt;&lt; ptr_3.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="built_in">shared_ptr</span>&lt;<span class="built_in">string</span>&gt; ptr_4 = <span class="built_in">std</span>::move(ptr_1);</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Count is: "</span> &lt;&lt; ptr_1.use_count() &lt;&lt; <span class="string">", "</span></div><div class="line">    &lt;&lt; ptr_2.use_count() &lt;&lt; <span class="string">", "</span> &lt;&lt; ptr_3.use_count() &lt;&lt; <span class="string">", "</span> &lt;&lt; ptr_4.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 is: "</span> &lt;&lt; ptr_1.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_4 is: "</span>  &lt;&lt; ptr_4.get() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Count is: 3, 3, 3</div><div class="line">ptr_1 is: 0x1210c20</div><div class="line">ptr_2 is: 0x1210c20</div><div class="line">ptr_3 is: 0x1210c20</div><div class="line"></div><div class="line">Count is: 0, 3, 3, 3</div><div class="line">ptr_1 is: 0</div><div class="line">ptr_4 is: 0x1210c20</div></pre></td></tr></table></figure></p>
<h4 id="shared-ptr-循环引用"><a href="#shared-ptr-循环引用" class="headerlink" title="shared_ptr 循环引用"></a>shared_ptr 循环引用</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;B&gt; ptr;</div><div class="line"></div><div class="line">    ~A() &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"kill A\n"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; ptr;</div><div class="line"></div><div class="line">    ~B() &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"kill B\n"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; ptr_1(<span class="keyword">new</span> A());</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;B&gt; ptr_2(<span class="keyword">new</span> B());</div><div class="line">    <span class="keyword">if</span> (ptr_1 &amp;&amp; ptr_2) &#123;</div><div class="line">        ptr_1-&gt;ptr = ptr_2;</div><div class="line">        ptr_2-&gt;ptr = ptr_1;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 use count:"</span> &lt;&lt; ptr_1.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_2 use count:"</span> &lt;&lt; ptr_2.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ptr_1 use count:2</div><div class="line">ptr_2 use count:2</div></pre></td></tr></table></figure></p>
<p>注意没有 kill A 与 kill  B，即动态对象没有被析构。<br><img src="/2019/03/14/RAII-smart-pointer/circular.png" alt="circular"></p>
<h4 id="weak-ptr"><a href="#weak-ptr" class="headerlink" title="weak_ptr"></a>weak_ptr</h4><p>结合 <code>shared_ptr</code> 使用的特殊智能指针。<code>weak_ptr</code> 不参与引用计数，不影响动态对象的生命期，即其存在与否并不影响对象的引用计数器。<code>weak_ptr</code> 并没有重载 <code>operator-&gt;</code> 和 <code>operator *</code> 操作符，因此不可直接通过 <code>weak_ptr</code> 使用对象，提供了 <code>expired()</code> 与 <code>lock()</code> 成员函数，前者用于判断 <code>weak_ptr</code> 指向的对象是否已被销毁，后者返回其所指对象的 <code>shared_ptr</code> 智能指针(对象销毁时返回”空” <code>shared_ptr</code>)。循环引用的场景：如二叉树中父节点与子节点的循环引用，容器与元素之间的循环引用。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; ptr;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say_hello</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"Hello"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ~B() &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"kill B\n"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    weak_ptr&lt;B&gt; ptr;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">do_something</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="built_in">shared_ptr</span>&lt;B&gt; tmp_ptr = ptr.lock();</div><div class="line">        <span class="keyword">if</span> (tmp_ptr) &#123;</div><div class="line">            tmp_ptr-&gt;say_hello();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ~A() &#123;</div><div class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"kill A\n"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; ptr_1(<span class="keyword">new</span> A());</div><div class="line">    <span class="built_in">shared_ptr</span>&lt;B&gt; ptr_2(<span class="keyword">new</span> B());</div><div class="line">    <span class="keyword">if</span> (ptr_1 &amp;&amp; ptr_2) &#123;</div><div class="line">        ptr_1-&gt;ptr = ptr_2;</div><div class="line">        ptr_2-&gt;ptr = ptr_1;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_1 use count:"</span> &lt;&lt; ptr_1.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ptr_2 use count:"</span> &lt;&lt; ptr_2.use_count() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    ptr_1-&gt;do_something();</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2019/03/14/RAII-smart-pointer/circular-2.png" alt="circular-2"><br>输出为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ptr_1 use count:2</div><div class="line">ptr_2 use count:1</div><div class="line">Hello</div><div class="line">kill B</div><div class="line">kill A</div></pre></td></tr></table></figure></p>
<p>在此种情况下，依次进行如下的析构：</p>
<ol>
<li>ptr_2</li>
<li>B</li>
<li>B.ptr</li>
<li>ptr_1</li>
<li>A</li>
<li>A.ptr</li>
</ol>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/C/">#C++</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This is Robert Lexis (FengCun Li). To see the world, things dangerous to come to, to see behind walls, to draw closer, to find each other and to feel. That is the purpose of LIFE.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/03/14/Perfect-forward/">Perfect forward</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/14/Move-semantic-perfect-forward/">Move semantic &amp; perfect f</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/14/RAII-smart-pointer/">RAII &amp; smart pointer</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/13/Leetcode/">Leetcode</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/RobertLexis">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:robert_lexis@163.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Robert Lexis Loves Wenny
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>